import openai
import os
from flask import Flask, request, jsonify

openai.api_key = os.environ.get("OPENAI_API_KEY")

app = Flask(__name__)

@app.route("/analyze-image", methods=["POST"])
def analyze_image():
    data = request.get_json()
    image_url = data.get("image_url")

    if not image_url:
        return jsonify({"error": "image_url is required"}), 400

    try:
        prompt = """
ุชุตุฑูู ูุฃูู ูุญูู ููู ูุญุชุฑู ููุฃุณูุงู ุงููุงููุฉ. ูุฏูู ุฎุจุฑุฉ ุชูุชุฏ ูุฃูุซุฑ ูู 20 ุณูุฉ ูู ุชุญููู ุฃุณูุงู ุงูููุฑูุณ ูุงูุฃุณูู ูุงูุนููุงุช ุงูุฑูููุฉ ุจุงุณุชุฎุฏุงู ุงูุชุญููู ุงูููู ูุงูุฃุณุงุณู. ุฃูุช ุฎุจูุฑ ูู ูุฑุงุกุฉ ุงูุดููุน ุงููุงุจุงููุฉุ ูููู ุงูุณููุ ููุงุทู ุงูุนุฑุถ ูุงูุทูุจุ ูุฃุฏูุงุช ูุซู RSIุ MACDุ ูุงููุชูุณุทุงุช ุงููุชุญุฑูุฉ.

ุงููุฏู: ุฃุฑุณู ูู ุตูุฑุฉ ุชุญุชูู ุนูู ุงูุฑุณู ุงูุจูุงูู (ุฃู ุงูุดูุนุฉ) ูุฃุฑูุฏ ููู ุฃู ุชูุฏู ูู ุชุญูููุงู ูููุงู ุงุญุชุฑุงููุงู ูุดุงููุงู ุงุนุชูุงุฏูุง ุนูู ูุญุชูู ุงูุตูุฑุฉ. ุงูุชุญููู ูุฌุจ ุฃู ูุณุงุนุฏูู ูู ุงุชุฎุงุฐ ูุฑุงุฑ: ูู ุงูููุช ููุงุณุจ ููุฏุฎูู ูู ุตููุฉ ุงูุขู ุฃู ูุง.

ุงูุฑุฌุงุก ุฃู ูุญุชูู ุงูุชุญููู ุนูู ุงูููุงุท ุงูุชุงููุฉ ุจุดูู ููุตู ูููุธู:
1. ุงูุงุชุฌุงู ุงูุนุงู ููุณูู โ ูู ุงูุณูู ูู ุงุชุฌุงู ุตุงุนุฏุ ูุงุจุทุ ุฃู ูู ุญุงูุฉ ุชุฐุจุฐุจ ุฌุงูุจูุ
2. ูุณุชููุงุช ุงูุฏุนู ูุงูููุงููุฉ ุงููููุฉ โ ุญุฏุฏ ุฃููู ุงูููุงุทู ุงูุณุนุฑููุฉ ุงูุชู ูููู ุฃู ุชุนูุณ ุญุฑูุฉ ุงูุณุนุฑ.
3. ุชุญููู ุงูุดููุน ุงููุงุจุงููุฉ โ ุฅุฐุง ูุงูุช ููุงู ุดููุน ูุงุถุญุฉ (ูุซู ุดููุน ุงุจุชูุงุนูุฉุ ุฏูุฌูุ ุงููุทุฑูุฉุ ุงูุฎ)ุ ูุงุดุฑุญ ูุงุฐุง ุชุนูู ูุฏูุงูุชูุง.
4. ูุฑุงุกุฉ ุงููุคุดุฑุงุช ุงููููุฉ โ ุฅุฐุง ูุงูุช ููุงู ูุคุดุฑุงุช ูุฑุฆูุฉ ูุซู RSI ุฃู MACD ุฃู ุงููุชูุณุทุงุชุ ูุงุดุฑุญ ูุง ุชุนููู ุญุงูููุง.
5. ุชุญููู ุงูุญุฌู โ ุฅุฐุง ูุงู ุงูุญุฌู ุธุงูุฑูุง ูู ุงูุตูุฑุฉุ ูุงุดุฑุญ ุฅุฐุง ูุงู ูุฏุนู ุงูุญุฑูุฉ ุงูุญุงููุฉ ุฃู ููุฐุฑ ุจุงูุนูุงุณ ูุงุฏู.
6. ุชูุตูุฉ ุงูุชุฏุงูู โ ุจูุงุกู ุนูู ุชุญูููู:
   โข ูู ุชูุตุญ ุจุงูุดุฑุงุกุ ุงูุจูุนุ ุฃู ุงูุงูุชุธุงุฑุ
   โข ุญุฏูุฏ ุณุนุฑ ุงูุฏุฎูู ุงูููุงุณุจ (Entry).
   โข ุญุฏูุฏ ููุทุฉ ููู ุงูุฎุณุงุฑุฉ (SL).
   โข ุญุฏูุฏ ููุทุฉ ุฌูู ุงูุฃุฑุจุงุญ (TP).
   โข ูุงุฐูุฑ ูุณุจุฉ ุงููุฎุงุทุฑุฉ ุฅูู ุงูุนุงุฆุฏ (Risk/Reward Ratio).
7. ุฏุฑุฌุฉ ุงูุซูุฉ ูู ุงูุชุญููู โ ุถุน ุชูููููุง (ููุฎูุถุ ูุชูุณุทุ ูุฑุชูุน) ููุฏู ุซูุชู ูู ูุฐุง ุงูุชุญูููุ ูุงุฐูุฑ ูุง ูู ุงูุณููุงุฑูู ุงูุฐู ูุฏ ูุคุฏู ุฅูู ุฅุจุทุงู ูุฐุง ุงูุชุญููู.

๐ ุจุนุฏ ุงูุชุญูููุ ูู ุจุชุญููู ุงูุงุณุชูุชุงุฌ ุงูููุงุฆู ุฅูู ูุงุฆู JSON ููุญูุฏ ุนูู ุงูุดูู ุงูุชุงูู:

{
  "buy": true | false,
  "confidence": "ููุฎูุถ" | "ูุชูุณุท" | "ูุฑุชูุน",
  "reason": "ุดุฑุญ ูุฎุชุตุฑ ุฌุฏุงู ูููุฑุงุฑ"
}

๐จ ููุงุญุธุฉ: ุฅุฐุง ูู ุชูู ุงูุตูุฑุฉ ูุงุถุญุฉ ููููุงุ ุงูุชุฑุถ ุงูููู ุจูุงุกู ุนูู ุชุฌุฑุจุชู ููุฏู ุฃูุถู ุชุญููู ูููู. ูุง ุชุฑุฏ ุจุฑุฏ ุชุนูููู ุฃู ุนุงูุ ุจู ุงูุชุฒู ุจุงูุชุญููู ุงูููู ุงูุนููู.
"""

        response = openai.chat.completions.create(
            model="gpt-4o",
            messages=[
                {
                    "role": "user",
                    "content": [
                        {"type": "text", "text": prompt},
                        {"type": "image_url", "image_url": {"url": image_url}}
                    ]
                }
            ]
        )

        return jsonify({"analysis": response.choices[0].message.content})
    except Exception as e:
        return jsonify({"error": str(e)}), 500

if __name__ == "__main__":
    port = int(os.environ.get("PORT", 10000))
    app.run(host="0.0.0.0", port=port)
