
import openai
import os
from flask import Flask, request, jsonify

openai.api_key = os.environ.get("OPENAI_API_KEY")

app = Flask(__name__)

@app.route("/analyze-image", methods=["POST"])
def analyze_image():
    data = request.get_json()
    image_url = data.get("image_url")

    if not image_url:
        return jsonify({"error": "image_url is required"}), 400

    try:
        prompt = """
تصرّف كأنك محلل فني محترف للأسواق المالية. لديك خبرة تمتد لأكثر من 20 سنة في تحليل أسواق الفوركس والأسهم والعملات الرقمية باستخدام التحليل الفني والأساسي. أنت خبير في قراءة الشموع اليابانية، هيكل السوق، مناطق العرض والطلب، وأدوات مثل RSI، MACD، والمتوسطات المتحركة.

الهدف: أرسل لك صورة تحتوي على الرسم البياني (أو الشمعة) وأريد منك أن تقدم لي تحليلاً فنياً احترافياً وشاملاً اعتمادًا على محتوى الصورة. التحليل يجب أن يساعدني في اتخاذ قرار: هل الوقت مناسب للدخول في صفقة الآن أم لا.

الرجاء أن يحتوي التحليل على النقاط التالية بشكل مفصل ومنظم:
1. الاتجاه العام للسوق — هل السوق في اتجاه صاعد، هابط، أم في حالة تذبذب جانبي؟
2. مستويات الدعم والمقاومة المهمة — حدد أقوى المناطق السعريّة التي يمكن أن تعكس حركة السعر.
3. تحليل الشموع اليابانية — إذا كانت هناك شموع واضحة (مثل شموع ابتلاعية، دوجي، المطرقة، الخ)، فاشرح ماذا تعني ودلالتها.
4. قراءة المؤشرات الفنية — إذا كانت هناك مؤشرات مرئية مثل RSI أو MACD أو المتوسطات، فاشرح ما تعنيه حاليًا.
5. تحليل الحجم — إذا كان الحجم ظاهرًا في الصورة، فاشرح إذا كان يدعم الحركة الحالية أو ينذر بانعكاس قادم.
6. توصية التداول — بناءً على تحليلك:
  • هل تنصح بالشراء، البيع، أو الانتظار؟
  • حدّد سعر الدخول المناسب (Entry).
  • حدّد نقطة وقف الخسارة (SL).
  • حدّد نقطة جني الأرباح (TP).
  • واذكر نسبة المخاطرة إلى العائد (Risk/Reward Ratio).
7. درجة الثقة في التحليل — ضع تقييمًا (منخفض، متوسط، مرتفع) لمدى ثقتك في هذا التحليل، واذكر ما هو السيناريو الذي قد يؤدي إلى إبطال هذا التحليل.

الرجاء تقديم التحليل بصيغة منظمة وسهلة القراءة باستخدام العناوين والنقاط. إذا كان هناك شيء غير واضح في الصورة، اذكر افتراضاتك بوضوح.

خذ نفسًا عميقًا وابدأ بحل هذه المسألة خطوة بخطوة.
"""

        response = openai.chat.completions.create(
            model="gpt-4o",
            messages=[
                {
                    "role": "user",
                    "content": [
                        {"type": "text", "text": prompt},
                        {"type": "image_url", "image_url": {"url": image_url}}
                    ]
                }
            ]
        )

        return jsonify({"analysis": response.choices[0].message.content})
    except Exception as e:
        return jsonify({"error": str(e)}), 500

if __name__ == "__main__":
    port = int(os.environ.get("PORT", 10000))
    app.run(host="0.0.0.0", port=port)
